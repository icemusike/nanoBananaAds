// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Account details
  name      String
  email     String   @unique
  password  String?  // Hashed password (nullable for migration)
  company   String?

  // Email verification
  emailVerified Boolean @default(false)
  verificationToken String?
  resetPasswordToken String?
  resetPasswordExpires DateTime?

  // API Keys (encrypted in production)
  geminiApiKey String?
  openaiApiKey String?

  // Image generation preferences
  preferredImageModel String @default("gemini") // "gemini" or "dalle"
  imageQuality        String @default("standard") // "standard" or "hd"

  // Ad generation preferences
  defaultIndustry     String?
  defaultTone         String @default("professional yet approachable")
  defaultAspectRatio  String @default("square")
  defaultModel        String @default("gpt-4o-2024-08-06") // Default OpenAI model for copy generation

  // Theme preferences
  theme               String @default("clean-slate") // Theme name
  themeMode           String @default("light") // dark or light

  // Default brand
  defaultBrandId      String?
  defaultBrand        Brand?  @relation("DefaultBrand", fields: [defaultBrandId], references: [id], onDelete: SetNull)

  // Usage tracking
  adsGenerated        Int @default(0)
  promptsGenerated    Int @default(0)
  anglesGenerated     Int @default(0)

  // Settings metadata
  settings            Json? // Additional flexible settings

  // JVZoo integration fields
  createdVia          String?  @default("signup") // "signup", "jvzoo", "manual"
  jvzooCustomerId     String?  // JVZoo customer ID for tracking
  jvzooTransactionId  String?  // First JVZoo transaction ID

  // Relationships
  brands              Brand[] @relation("UserBrands")
  prompts             Prompt[]
  angles              Angle[]
  ads                 Ad[]
  licenses            License[]
  jvzooTransactions   JVZooTransaction[]
  agencyClients       AgencyClient[] @relation("AgencyClients")

  @@index([email])
  @@index([defaultBrandId])
  @@index([jvzooCustomerId])
}

model Prompt {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // User ownership
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // User input
  idea        String   @db.Text // Simple idea from user

  // Generated content
  generatedPrompt String   @db.Text // Optimized prompt from OpenAI

  // Categorization
  industry     String? // Optional industry tag
  style        String? // UGC, Professional, Product-focused, etc.
  aspectRatio  String? // Square, Portrait, etc.

  // Metadata
  metadata     Json?   // Additional info like color palette suggestions, etc.

  // Usage tracking
  usageCount   Int     @default(0) // How many times used in ads

  // Relationship to Angle (optional)
  angleId      String? // If generated from an angle
  angle        Angle?  @relation(fields: [angleId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([createdAt])
  @@index([industry])
  @@index([style])
  @@index([angleId])
}

model Angle {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // User ownership
  userId              String?
  user                User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // User input (what they provided)
  businessName        String
  businessDescription String   @db.Text
  industry            String?
  targetAudience      String?
  currentApproach     String?  @db.Text

  // Generated angle data
  angleName           String   // e.g., "The Problem-Agitator"
  angleDescription    String   @db.Text // Strategy explanation
  whyItWorks          String   @db.Text // Psychology behind it
  targetEmotion       String   // Fear, Desire, Trust, Curiosity, etc.
  exampleHeadline     String   // Sample headline using this angle
  visualStyle         String   // Recommended visual approach
  copyFramework       String?  // AIDA, PAS, BAB, etc.

  // Metadata
  metadata            Json?    // Additional strategic info

  // Usage tracking
  usageCount          Int      @default(0) // How many times used
  promptsGenerated    Int      @default(0) // Prompts created from this angle
  adsGenerated        Int      @default(0) // Ads created from this angle

  // Performance tracking (optional future enhancement)
  performanceRating   Float?   // User-assigned rating 1-5
  performanceNotes    String?  @db.Text

  // Relationships
  prompts             Prompt[] // Prompts generated from this angle
  ads                 Ad[]     // Ads generated from this angle

  @@index([userId])
  @@index([createdAt])
  @@index([industry])
  @@index([targetEmotion])
  @@index([usageCount])
}

model Ad {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // User ownership
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Image data
  imageData     String // Base64 encoded image
  imageMimeType String // image/png, etc.
  imageMetadata Json   // Model info, timestamp, etc.

  // Ad copy
  headline               String
  description            String
  primaryText            String   @db.Text
  callToAction           String
  alternativeHeadlines   Json?    // Array of strings
  keyBenefits            Json?    // Array of strings
  toneAnalysis           String?  @db.Text

  // AI Model used
  copyModel              String   @default("gpt-4o-2024-08-06") // OpenAI model used for copy generation

  // Form data / metadata
  productDescription String   @db.Text
  targetAudience     String
  industry           String
  category           String
  template           String
  tone               String
  colorPalette       String?
  aspectRatio        String
  valueProposition   String?

  // Relationship to Angle (optional)
  angleId            String? // If generated from an angle
  angle              Angle?  @relation(fields: [angleId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([createdAt])
  @@index([industry])
  @@index([category])
  @@index([angleId])
}

model Brand {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Brand Identity
  name              String   // Brand/Company name
  description       String   @db.Text // What the brand does
  tagline           String?  // Brand tagline/slogan
  logo              String?  @db.Text // Base64 encoded logo image
  logoMimeType      String?  // image/png, image/svg+xml, etc.

  // Brand Visual Identity
  primaryColor      String?  // Hex color
  secondaryColor    String?  // Hex color
  accentColor       String?  // Hex color
  colorPalette      String?  // Comma-separated hex colors

  // Brand Voice & Messaging
  industry          String?  // Industry/vertical
  targetAudience    String?  @db.Text // Primary target audience
  brandVoice        String?  @db.Text // How the brand communicates
  tone              String   @default("professional yet approachable")
  valueProposition  String?  @db.Text // Core value prop
  keyMessages       Json?    // Array of key brand messages

  // Additional Brand Assets
  brandGuidelines   String?  @db.Text // Brand guidelines/notes
  websiteUrl        String?  // Brand website
  socialMediaLinks  Json?    // Object with social media links

  // Metadata
  metadata          Json?    // Additional flexible data

  // Usage tracking
  usageCount        Int      @default(0) // Times used in generation
  lastUsed          DateTime?

  // Relationships
  userId            String   // Owner of this brand
  user              User     @relation("UserBrands", fields: [userId], references: [id], onDelete: Cascade)

  // Default brand relationships
  defaultForUsers   User[]   @relation("DefaultBrand")

  @@index([userId])
  @@index([createdAt])
  @@index([industry])
  @@index([name])
}

// JVZoo License Management
model License {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // License details
  licenseKey          String   @unique // Generated license key (e.g., XXXX-XXXX-XXXX-XXXX)
  productId           String   // Internal product identifier
  status              String   @default("active") // active, refunded, chargeback, cancelled, expired

  // JVZoo transaction info
  jvzooTransactionId  String   @unique // JVZoo ctransaction
  jvzooReceiptId      String?  // JVZoo receipt number
  jvzooProductId      String   // JVZoo cproditem
  transactionType     String   // SALE, RFND, CGBK, INSTAL, CANCEL-REBILL

  // Purchase info
  purchaseDate        DateTime @default(now())
  purchaseAmount      Float?   // Sale amount
  expiryDate          DateTime? // For time-limited licenses

  // Subscription tracking (for recurring products)
  isRecurring         Boolean  @default(false)
  lastPaymentDate     DateTime?
  paymentCount        Int      @default(1)
  nextBillingDate     DateTime?

  // Status changes
  refundedAt          DateTime?
  chargebackAt        DateTime?
  cancelledAt         DateTime?

  // Usage tracking
  lastValidated       DateTime?
  activations         Int      @default(0)
  maxActivations      Int      @default(1)

  // Metadata
  metadata            Json?    // Additional flexible data

  // Relationships
  userId              String
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([licenseKey])
  @@index([jvzooTransactionId])
  @@index([status])
  @@index([productId])
  @@index([createdAt])
}

// JVZoo Transaction Audit Log
model JVZooTransaction {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Transaction identification
  jvzooTransactionId  String   @unique // JVZoo ctransaction (idempotency key)
  jvzooReceiptId      String?  // JVZoo receipt number
  transactionType     String   // SALE, RFND, CGBK, INSTAL, CANCEL-REBILL

  // Product info
  jvzooProductId      String   // JVZoo cproditem
  productType         String?  // STANDARD, RECURRING, etc.

  // Customer info
  customerEmail       String
  customerName        String?
  customerCountry     String?
  customerState       String?

  // Financial info
  amount              Float?   // Sale amount
  affiliateCommission Float?   // Commission paid to affiliate
  vendorEarnings      Float?   // Your earnings

  // Verification
  verificationHash    String   // JVZoo cverify hash
  verified            Boolean  @default(false)

  // Processing status
  processed           Boolean  @default(false)
  processedAt         DateTime?
  processingError     String?  @db.Text

  // Raw IPN data
  rawIpnData          Json     // Complete IPN payload for debugging

  // Relationships
  userId              String?  // Linked user (if processed successfully)
  user                User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([jvzooTransactionId])
  @@index([customerEmail])
  @@index([userId])
  @@index([processed])
  @@index([createdAt])
  @@index([jvzooProductId])
}

// Agency Client Management (for users with agency license)
model AgencyClient {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Agency owner (user with agency license)
  agencyUserId    String
  agencyUser      User     @relation("AgencyClients", fields: [agencyUserId], references: [id], onDelete: Cascade)

  // Client account details
  clientEmail     String
  clientName      String?
  clientCompany   String?
  clientPassword  String?  // Hashed password for client portal access

  // Access token for client portal
  accessToken     String?  @unique
  tokenExpiry     DateTime?

  // Status
  status          String   @default("active") // active, suspended, deleted

  // Credits/limits
  creditsAllocated Int?    // Optional credit limit
  creditsUsed      Int      @default(0)

  // Last login tracking
  lastLoginAt     DateTime?

  // Stats (computed from client's generated content)
  stats           Json?    // { projects: 0, ads: 0, prompts: 0 }

  // Metadata
  metadata        Json?    // Additional flexible data
  notes           String?  @db.Text // Agency notes about this client

  @@index([agencyUserId])
  @@index([clientEmail])
  @@index([status])
  @@index([accessToken])
  @@unique([agencyUserId, clientEmail]) // One email per agency
}

// System settings for admin configuration
model SystemSettings {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Setting key-value pair
  key       String   @unique
  value     String?  @db.Text
  category  String   @default("general") // general, api_keys, features, etc.

  @@index([key])
  @@index([category])
}
